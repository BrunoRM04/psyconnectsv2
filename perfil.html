<!DOCTYPE html>
<html lang="es">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PsyConnects | Perfil Profesional</title>
    <link rel="stylesheet" href="public/css/styles.css">
    <link rel="shortcut icon" href="public/img/marca/icono-psyconnects.png">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

</head>

<body>

    <div class="barra-promocional">
        <p class="mensaje-promocional">
            üéÅ ¬°Tu primera sesi√≥n con nosotros es totalmente gratis! üéÅ
        </p>
    </div>

    <header class="encabezado-principal">

        <div class="contenedor-logo">
            <a href="index.html"><img src="public/img/marca/logo cuatro.png" alt="Logo del sitio"
                    class="logo-imagen"></a>
        </div>
        <div class="contenedor-iconos">
            <a href="login.html"><i class='bx bx-user icono-cuenta'></i></a>
            <i class='bx bx-menu icono-hamburguesa'></i>
        </div>

    </header>

    <nav class="menu-desplegable" id="menuDesplegable">
        <i class='bx bx-x icono-cerrar' id="cerrarMenu"></i>
        <ul class="lista-navegacion">
            <li><a href="index.html">üè† Inicio</a></li>
            <li><a href="psicologos-disponibles.html">üë• Psic√≥logos Disponibles</a></li>
            <li><a href="nuestra-historia.html">üìñ Nuestra Historia</a></li>
        </ul>
    </nav>

    <main>
        <section class="perfil-seccion-principal">
            <div class="perfil-distribucion-dos-columnas">

                <aside class="perfil-columna-izquierda">
                    <div class="perfil-caja-izquierda">

                        <img id="perfil-foto-usuario" class="perfil-imagen-usuario" src="" alt="Foto del profesional">

                        <h1 id="perfil-nombre-completo" class="perfil-nombre-completo">Nombre Apellido</h1>

                        <div class="perfil-datos-personales-simples">
                            <p>üéÇ <span id="perfil-edad"></span></p>
                            <p>üìç <span id="perfil-pais"></span></p>
                            <p>üöª <span id="perfil-genero"></span></p>
                            <p>üßë‚Äç‚öïÔ∏è <span id="perfil-modalidad"></span></p>
                            <p>üí∞ <span id="perfil-precio"></span> USD/hr</p>
                        </div>

                        <div id="perfil-chips-terapias" class="perfil-chips-terapias"></div>

                    </div>
                </aside>

                <div class="perfil-columna-derecha">

                    <div class="perfil-bloque-descripcion perfil-aparecer">
                        <h2 class="perfil-titulo-seccion">üìù Descripci√≥n</h2>
                        <p id="perfil-descripcion" class="perfil-texto-descripcion"></p>
                    </div>

                    <div class="perfil-bloque-experiencia perfil-aparecer">
                        <h2 class="perfil-titulo-seccion">üíº Experiencia Profesional</h2>
                        <div id="perfil-lista-experiencia" class="perfil-listado-experiencia"></div>
                    </div>

                    <div class="perfil-bloque-certificaciones perfil-aparecer">
                        <h2 class="perfil-titulo-seccion">üìö Certificaciones</h2>
                        <div id="perfil-lista-certificaciones" class="perfil-listado-certificaciones"></div>
                    </div>

                    <div class="perfil-bloque-idiomas-enfoques perfil-aparecer">
                        <h2 class="perfil-titulo-seccion">üåê Idiomas y √Åreas de Enfoque</h2>
                        <div class="perfil-contenedor-idiomas-enfoques">
                            <div class="perfil-columna-idiomas">
                                <h3>üó£Ô∏è Idiomas</h3>
                                <div id="perfil-chips-idiomas" class="perfil-chips"></div>
                            </div>
                            <div class="perfil-columna-enfoques">
                                <h3>üß† Enfoques</h3>
                                <div id="perfil-chips-enfoques" class="perfil-chips"></div>
                            </div>
                        </div>
                    </div>

                    <div class="perfil-bloque-video perfil-aparecer">
                        <h2 class="perfil-titulo-seccion">üé• Video de Presentaci√≥n</h2>
                        <div id="perfil-contenedor-video" class="perfil-video-contenedor"></div>
                    </div>

                    <div class="perfil-bloque-documentos perfil-aparecer">
                        <h2 class="perfil-titulo-seccion">üìÑ Documentos Adjuntos</h2>
                        <div id="perfil-contenedor-documentos" class="perfil-documentos-contenedor"></div>
                    </div>

                    <div class="perfil-aparecer">
                        <h2 class="perfil-titulo-seccion">üîó Redes Sociales</h2>
                        <div id="perfil-redes-iconos" class="perfil-iconos-redes"></div>
                    </div>

                </div>
            </div>
        </section>
    </main>

    <footer class="pie-pagina">

        <div class="contenedor-pie">
            <div class="columna sobre-nosotros">
                <h3 class="titulo-columna">Sobre nosotros</h3>
                <ul class="lista-enlaces">
                    <li><a href="#">¬øQui√©nes somos?</a></li>
                    <li><a href="#">Misi√≥n y visi√≥n</a></li>
                    <li><a href="#">Noticias</a></li>
                    <li><a href="#">Trabaja con nosotros</a></li>
                </ul>
            </div>

            <div class="columna navegacion">
                <h3 class="titulo-columna">Navegaci√≥n</h3>
                <ul class="lista-enlaces">
                    <li><a href="#">Inicio</a></li>
                    <li><a href="#">Psic√≥logos</a></li>
                    <li><a href="#">Testimonios</a></li>
                    <li><a href="#">Registro / Login</a></li>
                </ul>
            </div>

            <div class="columna contacto-redes">
                <h3 class="titulo-columna">Redes sociales</h3>
                <div class="iconos-redes">
                    <a href="https://www.instagram.com/psyconnectsweb/"><i class='bx bxl-instagram'></i></a>
                    <a href="https://www.facebook.com/profile.php?id=61577232808057"><i class='bx bxl-facebook'></i></a>
                    <a href="https://www.linkedin.com/company/psyconnects/"><i class='bx bxl-linkedin'></i></a>
                </div>
            </div>
        </div>

        <div class="barra-inferior">
            <p>¬© 2025 PsyConnects. Todos los derechos reservados.</p>
            <div class="enlaces-legales">
                <a href="#">Cookies</a>
                <span class="separador-legales">|</span>
                <a href="#">Accesibilidad</a>
                <span class="separador-legales">|</span>
                <a href="#">Aviso legal</a>
            </div>
        </div>

    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import {
            getFirestore,
            collection,
            getDocs,
            doc,
            getDoc,
            addDoc
        } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCFrMomIGmjYdJdXswCEwJT62JJtyyY4UM",
            authDomain: "psyconnects-web.firebaseapp.com",
            projectId: "psyconnects-web"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        function obtenerParametro(nombre) {
            const params = new URLSearchParams(window.location.search);
            return params.get(nombre);
        }

        function calcularEdad(fecha) {
            const hoy = new Date();
            const nacimiento = new Date(fecha);
            let edad = hoy.getFullYear() - nacimiento.getFullYear();
            const m = hoy.getMonth() - nacimiento.getMonth();
            if (m < 0 || (m === 0 && hoy.getDate() < nacimiento.getDate())) edad--;
            return edad;
        }

        async function buscarPsicologo(correo) {
            const colecciones = ["usuarios_plus", "usuarios_free"];
            for (const nombre of colecciones) {
                const snap = await getDocs(collection(db, nombre));
                for (const doc of snap.docs) {
                    const datos = doc.data();
                    if (datos.correo === correo) {
                        datos.tipoCuenta = nombre === "usuarios_plus" ? "plus" : "free"; // ‚¨ÖÔ∏è A√ëADIDO CLAVE
                        datos.uid = doc.id; // A√ëADIDO
                        return datos;
                    }
                }
            }
            return null;
        }

        function crearChips(lista) {
            return (lista || []).map(item => `<span>${item}</span>`).join('');
        }

        function crearExperiencia(lista) {
            return (lista || []).map(item => `
    <div class="perfil-item-experiencia">
      <strong>${item.lugar}</strong> (${item.periodo})<br>
      <em>${item.tareas}</em>
      ${item.actualmente ? "<div class='perfil-chips'><span>Actualmente</span></div>" : ""}
    </div>
  `).join('');
        }

        function crearCertificaciones(lista) {
            return (lista || []).map(item => `
    <div class="perfil-item-certificacion">
      <strong>${item.nombre}</strong><br>
      ${item.inicio} - ${item.fin}
    </div>
  `).join('');
        }

        function mostrarVideo(datos) {
            if (datos.videoArchivoURL) {
                return `<video controls><source src="${datos.videoArchivoURL}" type="video/mp4"></video>`;
            } else if (datos.videoLink) {
                return `<a href="${datos.videoLink}" target="_blank" style="color: var(--color-principal);">Ver video externo</a>`;
            } else {
                return `<p>No hay video disponible.</p>`;
            }
        }

        function mostrarDocumentos(urls) {
            return (urls || []).map((url, i) => `<a href="${url}" target="_blank">üìÑ Documento ${i + 1}</a>`).join('<br>');
        }

        function mostrarRedes(datos) {
            let html = "";
            if (datos.instagram) html += `<a href="${datos.instagram}" target="_blank"><i class='bx bxl-instagram'></i></a>`;
            if (datos.facebook) html += `<a href="${datos.facebook}" target="_blank"><i class='bx bxl-facebook'></i></a>`;
            if (datos.linkedin) html += `<a href="${datos.linkedin}" target="_blank"><i class='bx bxl-linkedin'></i></a>`;
            if (datos.tiktok) html += `<a href="${datos.tiktok}" target="_blank"><i class='bx bxl-tiktok'></i></a>`;
            return html;
        }

        async function cargarPerfil() {
            const correo = obtenerParametro("id");
            if (!correo) return alert("No se proporcion√≥ un ID de perfil.");

            const datos = await buscarPsicologo(correo);
            if (!datos) return alert("No se encontr√≥ el perfil.");

            const esPlus = window.location.href.includes("usuarios_plus");

            const contenedorIzquierdo = document.querySelector(".perfil-caja-izquierda");

            const boton = document.createElement("button");
            boton.className = "boton-reservar-cita";

            if (datos.tipoCuenta === "plus") {
                const botonReservar = document.createElement("button");
                botonReservar.className = "boton-reservar-cita";
                botonReservar.textContent = "Reservar Cita Ahora";
                botonReservar.onclick = async () => {
                    try {
                        const docRef = doc(db, "usuarios_plus", datos.uid);
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            const horarios = docSnap.data().horariosDisponibles || [];
                            iniciarReservaConDatos(horarios, datos.uid);
                        } else {
                            alert("No se encontr√≥ disponibilidad.");
                        }
                    } catch (error) {
                        console.error("Error al obtener horarios:", error);
                        alert("Hubo un error al cargar los horarios.");
                    }
                };
                contenedorIzquierdo.appendChild(botonReservar);
            } else if (datos.tipoCuenta === "free") {
                const botonConsulta = document.createElement("button");
                botonConsulta.className = "boton-reservar-cita"; // usa el mismo estilo
                botonConsulta.textContent = "Consultar Disponibilidad";
                botonConsulta.onclick = () => {
                    const nombreCompleto = `${datos.nombre} ${datos.apellido}`;
                    const mensaje = `¬°Hola! Estoy viendo el perfil de ${nombreCompleto} en PsyConnects y me gustar√≠a consultar su disponibilidad. ¬øPod√©s brindarme m√°s informaci√≥n?`;
                    const url = `https://wa.me/59899043009?text=${encodeURIComponent(mensaje)}`;
                    window.open(url, '_blank');
                };
                contenedorIzquierdo.appendChild(botonConsulta);
            }

            document.getElementById("perfil-foto-usuario").src = datos.fotoPerfilURL || "";
            document.getElementById("perfil-nombre-completo").textContent = `${datos.nombre} ${datos.apellido}`;
            document.getElementById("perfil-edad").textContent = `${calcularEdad(datos.fechaNacimiento)} a√±os`;
            document.getElementById("perfil-pais").textContent = datos.pais || "";
            document.getElementById("perfil-genero").textContent = datos.genero || "";
            document.getElementById("perfil-modalidad").textContent = datos.modalidad || "";
            document.getElementById("perfil-precio").textContent = datos.precio || "";
            document.getElementById("perfil-chips-terapias").innerHTML = crearChips(datos.terapias);

            document.getElementById("perfil-descripcion").textContent = datos.descripcion || "";
            document.getElementById("perfil-lista-experiencia").innerHTML = crearExperiencia(datos.experienciaProfesional);
            document.getElementById("perfil-lista-certificaciones").innerHTML = crearCertificaciones(datos.certificaciones);
            document.getElementById("perfil-chips-idiomas").innerHTML = crearChips(datos.idiomas);
            document.getElementById("perfil-chips-enfoques").innerHTML = crearChips(datos.enfoques);
            document.getElementById("perfil-contenedor-video").innerHTML = mostrarVideo(datos);
            document.getElementById("perfil-contenedor-documentos").innerHTML = mostrarDocumentos(datos.documentosAdjuntos);
            document.getElementById("perfil-redes-iconos").innerHTML = mostrarRedes(datos);
        }

        cargarPerfil();

        const observador = new IntersectionObserver(entradas => {
            entradas.forEach(entrada => {
                if (entrada.isIntersecting) {
                    entrada.target.classList.add('activo');
                    observador.unobserve(entrada.target);
                }
            });
        }, { threshold: 0.1 });

        document.querySelectorAll('.perfil-aparecer').forEach(el => {
            observador.observe(el);
        });

        function mostrarHorariosDisponiblesParaReserva(horarios, datosUsuario, uidPsicologo) {
            const modal = document.createElement("div");
            modal.className = "modal-disponibilidad-fondo";

            const contenido = document.createElement("div");
            contenido.className = "modal-disponibilidad-contenedor";

            const dias = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            const meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio',
                'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];

            function formatear(h) {
                const fecha = new Date(h.fecha);
                return `${dias[fecha.getDay()]} ${fecha.getDate()} de ${meses[fecha.getMonth()]}, ${h.horaInicio} a ${h.horaFin}`;
            }

            contenido.innerHTML = `
        <h3 class="modal-disponibilidad-titulo">Eleg√≠ un horario</h3>
        <select id="selector-horario" class="selector-horario-disponible">
            <option value="" disabled selected>Seleccion√° una opci√≥n</option>
            ${horarios.map((h, i) => `<option value="${i}">${formatear(h)}</option>`).join('')}
        </select>
        <div class="grupo-botones-reserva">
            <button id="boton-confirmar-reserva" class="boton-reserva-disponible" disabled>Reservar ahora ‚úÖ</button>
            <button id="cerrar-modal-final" class="boton-reserva-disponible">Cancelar</button>
        </div>
    `;

            modal.appendChild(contenido);
            document.body.appendChild(modal);

            const selector = document.getElementById("selector-horario");
            const botonConfirmar = document.getElementById("boton-confirmar-reserva");

            selector.addEventListener("change", () => {
                botonConfirmar.disabled = false;
            });

            botonConfirmar.addEventListener("click", async () => {
                const seleccion = horarios[selector.value];
                try {
                    await addDoc(collection(db, "reservas"), {
                        nombre: datosUsuario.nombre,
                        telefono: datosUsuario.telefono,
                        correo: datosUsuario.correo,
                        pais: datosUsuario.pais,
                        horario: seleccion,
                        uidPsicologo: uidPsicologo,
                        timestamp: new Date()
                    });

                    // Armar mensaje para WhatsApp
                    const fecha = new Date(seleccion.fecha);
                    const dias = ['domingo', 'lunes', 'martes', 'mi√©rcoles', 'jueves', 'viernes', 's√°bado'];
                    const meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio',
                        'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];

                    const diaTexto = `${dias[fecha.getDay()]} ${fecha.getDate()} de ${meses[fecha.getMonth()]}`;
                    const mensaje = `¬°Hola! Vi tu perfil en PsyConnects y me gustar√≠a confirmar mi sesi√≥n el ${diaTexto} de ${seleccion.horaInicio} a ${seleccion.horaFin}.%0A%0AMi nombre es ${datosUsuario.nombre}, soy de ${datosUsuario.pais}.%0AMi n√∫mero es ${datosUsuario.telefono} y mi correo es ${datosUsuario.correo}.%0A%0A¬°Gracias!`;

                    // Obtener n√∫mero del psic√≥logo
                    const psicologoDoc = await getDoc(doc(db, "usuarios_plus", uidPsicologo));
                    const numeroWhatsApp = psicologoDoc.data().telefono?.replace(/\D/g, '');

                    if (!numeroWhatsApp) {
                        alert("‚úÖ Reserva confirmada, pero no se encontr√≥ el n√∫mero de WhatsApp del profesional.");
                        modal.remove();
                        return;
                    }

                    // Redirigir a WhatsApp
                    const url = `https://wa.me/${numeroWhatsApp}?text=${mensaje}`;
                    window.location.href = url;

                } catch (error) {
                    console.error("Error al guardar reserva:", error);
                    alert("‚ùå Ocurri√≥ un error al guardar tu reserva.");
                }
            });

            document.getElementById("cerrar-modal-final").addEventListener("click", () => modal.remove());
        }

        function iniciarReservaConDatos(horarios, uidPsicologo) {
            const modal = document.createElement("div");
            modal.className = "modal-disponibilidad-fondo";

            const contenido = document.createElement("div");
            contenido.className = "modal-disponibilidad-contenedor";

            contenido.innerHTML = `
    <h3 class="modal-disponibilidad-titulo">¬°Ya casi est√° lista tu reserva!</h3>
    <p class="modal-disponibilidad-mensaje">* Como regalo de bienvenida, tu primera sesi√≥n ser√° 100% gratuita.</p>
    
    <input type="text" id="nombre-reserva" class="input-modal-reserva" placeholder="Nombre y apellido" required>
    <input type="tel" id="telefono-reserva" class="input-modal-reserva" placeholder="Tel√©fono" required>
    <input type="email" id="correo-reserva" class="input-modal-reserva" placeholder="Correo electr√≥nico" required>
    <input type="text" id="pais-reserva" class="input-modal-reserva" placeholder="Pa√≠s" required>

    <div class="grupo-botones-reserva">
        <button id="boton-siguiente-reserva" class="boton-reserva-disponible">Siguiente ‚û°Ô∏è</button>
        <button id="cerrar-modal-inicial" class="boton-reserva-disponible">Cancelar</button>
    </div>
`;

            modal.appendChild(contenido);
            document.body.appendChild(modal);

            document.getElementById("cerrar-modal-inicial").addEventListener("click", () => modal.remove());

            document.getElementById("boton-siguiente-reserva").addEventListener("click", () => {
                const nombre = document.getElementById("nombre-reserva").value.trim();
                const telefono = document.getElementById("telefono-reserva").value.trim();
                const correo = document.getElementById("correo-reserva").value.trim();
                const pais = document.getElementById("pais-reserva").value.trim();

                if (!nombre || !telefono || !correo || !pais) {
                    alert("Por favor complet√° todos los campos.");
                    return;
                }

                modal.remove();
                mostrarHorariosDisponiblesParaReserva(horarios, { nombre, telefono, correo, pais }, uidPsicologo);
            });
        }

    </script>

    <script>

        const menu = document.getElementById('menuDesplegable');
        const abrir = document.querySelector('.icono-hamburguesa');
        const cerrar = document.getElementById('cerrarMenu');

        abrir.addEventListener('click', () => {
            menu.classList.add('activo');
        });

        cerrar.addEventListener('click', () => {
            menu.classList.remove('activo');
        });

        function mostrarCargador() {
            const fondo = document.getElementById('fondo-cargador');
            const linea = document.getElementById('linea-carga');

            fondo.style.opacity = '1';
            fondo.style.pointerEvents = 'auto';
            linea.style.width = '0%';

            let progreso = 0;
            const intervalo = setInterval(() => {
                if (progreso >= 100) {
                    clearInterval(intervalo);
                    setTimeout(() => {
                        fondo.style.opacity = '0';
                        fondo.style.pointerEvents = 'none';
                    }, 300);
                } else {
                    progreso += 1;
                    linea.style.width = progreso + '%';
                }
            }, 10);
        }

        window.addEventListener('load', mostrarCargador);

        document.addEventListener('click', function (e) {
            const tag = e.target.tagName.toLowerCase();
            if (['a', 'button'].includes(tag) || e.target.closest('a') || e.target.closest('button')) {
                mostrarCargador();
            }
        });

    </script>

</body>

</html>